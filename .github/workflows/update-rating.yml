name: Update Developer Rating

on:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  update-rating:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Compute rating from GitHub API and update README
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 <<'EOF'
          import os, json, urllib.request, math, re, datetime

          USERNAME = "simiyu-samuel"
          TOKEN = os.environ["GH_TOKEN"]

          def gql(query, variables=None):
              payload = json.dumps({"query": query, "variables": variables or {}}).encode()
              req = urllib.request.Request(
                  "https://api.github.com/graphql",
                  data=payload,
                  headers={
                      "Authorization": f"Bearer {TOKEN}",
                      "Content-Type": "application/json"
                  }
              )
              return json.loads(urllib.request.urlopen(req).read())

          result = gql("""
          query($login: String!) {
            user(login: $login) {
              repositories(ownerAffiliations: OWNER, first: 100, isFork: false) {
                totalCount
                nodes { stargazerCount forkCount primaryLanguage { name } }
              }
              contributionsCollection {
                totalCommitContributions
                totalPullRequestContributions
                totalIssueContributions
                contributionCalendar {
                  totalContributions
                  weeks { contributionDays { contributionCount } }
                }
              }
              followers { totalCount }
              pullRequests(states: MERGED) { totalCount }
              issues { totalCount }
            }
          }
          """, {"login": USERNAME})["data"]["user"]

          repos = result["repositories"]["nodes"]
          contrib = result["contributionsCollection"]
          cal = contrib["contributionCalendar"]

          total_stars = sum(r["stargazerCount"] for r in repos)
          total_forks = sum(r["forkCount"] for r in repos)
          repo_count = result["repositories"]["totalCount"]
          commits = contrib["totalCommitContributions"]
          prs_merged = result["pullRequests"]["totalCount"]
          issues = result["issues"]["totalCount"]
          followers = result["followers"]["totalCount"]
          total_contrib = cal["totalContributions"]

          days = [d["contributionCount"] for w in cal["weeks"] for d in w["contributionDays"]]
          streak = 0
          for c in reversed(days):
              if c > 0:
                  streak += 1
              else:
                  break

          lang_count = {}
          for r in repos:
              if r["primaryLanguage"]:
                  name = r["primaryLanguage"]["name"]
                  lang_count[name] = lang_count.get(name, 0) + 1
          top_langs = ", ".join(k for k, _ in sorted(lang_count.items(), key=lambda x: -x[1])[:4]) or "N/A"

          def clamp(v):
              return max(0.0, min(1.0, v))

          s_stars = clamp(math.log10(total_stars + 1) / math.log10(500)) * 2.0
          s_commits = clamp(math.log10(commits + 1) / math.log10(2000)) * 2.5
          s_prs = clamp(math.log10(prs_merged + 1) / math.log10(200)) * 1.5
          s_repos = clamp(math.log10(repo_count + 1) / math.log10(50)) * 1.0
          s_followers = clamp(math.log10(followers + 1) / math.log10(500)) * 1.0
          s_streak = clamp(streak / 90) * 1.0
          s_contrib = clamp(math.log10(total_contrib + 1) / math.log10(1500)) * 1.0

          rating = round(min(s_stars + s_commits + s_prs + s_repos + s_followers + s_streak + s_contrib, 10), 1)

          updated = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")

          # Determine developer level
          if rating >= 8.5:
              level = "ğŸ† Master Developer"
              level_desc = "Elite-level expertise with exceptional contributions"
          elif rating >= 7.0:
              level = "ğŸš€ Advanced Developer"
              level_desc = "Strong skills with significant project experience"
          elif rating >= 5.0:
              level = "ğŸ’¡ Intermediate Developer"
              level_desc = "Solid foundation with growing expertise"
          else:
              level = "ğŸŒ± Beginner Developer"
              level_desc = "Building skills and gaining experience"

          def progress_bar(value, max_val):
              percentage = int((value / max_val) * 100) if max_val > 0 else 0
              filled = int(percentage / 5)
              empty = 20 - filled
              return "â–ˆ" * filled + "â–‘" * empty

          block = f"""<!-- DEVELOPER-RATING:START -->

          <div align="center">

          ### {level}
          ## ğŸ¯ {rating}/10.0
          *{level_desc}*

          </div>

          <table align="center">
          <tr>
          <td width="50%" valign="top">

          #### ğŸ“Š GitHub Statistics
          | Metric | Value |
          |--------|-------|
          | â­ Total Stars | **{total_stars}** |
          | ğŸ´ Total Forks | **{total_forks}** |
          | ğŸ“¦ Public Repos | **{repo_count}** |
          | ğŸ”€ PRs Merged | **{prs_merged}** |
          | ğŸ› Issues Opened | **{issues}** |
          | ğŸ”¥ Current Streak | **{streak} days** |
          | ğŸ‘¥ Followers | **{followers}** |
          | ğŸ“… Total Contributions | **{total_contrib}** |

          </td>
          <td width="50%" valign="top">

          #### ğŸ¯ Score Breakdown
          | Category | Progress | Score |
          |----------|----------|-------|
          | â­ Stars | {progress_bar(s_stars, 2.0)} | {s_stars:.2f}/2.0 |
          | ğŸ”¥ Commits | {progress_bar(s_commits, 2.5)} | {s_commits:.2f}/2.5 |
          | ğŸ”€ PRs | {progress_bar(s_prs, 1.5)} | {s_prs:.2f}/1.5 |
          | ğŸ“¦ Repos | {progress_bar(s_repos, 1.0)} | {s_repos:.2f}/1.0 |
          | ğŸ‘¥ Followers | {progress_bar(s_followers, 1.0)} | {s_followers:.2f}/1.0 |
          | ğŸ”¥ Streak | {progress_bar(s_streak, 1.0)} | {s_streak:.2f}/1.0 |
          | ğŸ“… Activity | {progress_bar(s_contrib, 1.0)} | {s_contrib:.2f}/1.0 |

          </td>
          </tr>
          </table>

          <div align="center">

          **ğŸŒ Top Languages:** {top_langs}  
          *Last updated: {updated}*

          </div>

          <!-- DEVELOPER-RATING:END -->"""

          with open("README.md", "r") as f:
              content = f.read()
          patched = re.sub(r"<!-- DEVELOPER-RATING:START -->.*?<!-- DEVELOPER-RATING:END -->", block, content, flags=re.DOTALL)
          with open("README.md", "w") as f:
              f.write(patched)

          print(f"âœ… Rating: {rating}/10 ({level}) | Stars: {total_stars} | Commits: {commits} | Streak: {streak}d")
          EOF

      - name: Commit updated README
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git diff --cached --quiet || git commit -m "chore: auto-update developer rating [skip ci]"
          git push
